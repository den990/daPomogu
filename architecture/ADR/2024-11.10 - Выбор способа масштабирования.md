**Дата:** 6 ноября 2024 г.  
**Статус:** Принято

---

### **Контекст**

С увеличением объема данных и числа пользователей (SCA02, SCA03), а также с необходимостью обеспечения высокой доступности (AVA01) и отказоустойчивости (DUR02), встает задача эффективного управления данными. Согласно прогнозам, единственный сервер базы данных не справится с увеличением нагрузки. Для обеспечения быстрого доступа к данным, особенно для пользователей из разных регионов, требуется подход, который одновременно обеспечит масштабируемость и высокую доступность.

---

### **Решение:**

**Масштабирование данных с использованием шардинга и репликации**

Для оптимизации производительности и отказоустойчивости, предлагается комбинированный подход:

1. **Шардинг** — распределение данных между несколькими независимыми базами данных в зависимости от региональной привязки.
2. **Репликация** — создание реплик для каждой шардированной базы данных для обеспечения высокой доступности и отказоустойчивости.

---

### **Компоненты решения:**

1. **Шардирование:**
    
    - Разделение данных по регионам, где каждая шардированная база данных обрабатывает запросы только для своего региона.
    - Шардирование по регионам:
        - Москва
        - Санкт-Петербург
        - Татарстан (Казань)
        - Новосибирская область
        - Екатеринбург
        - Краснодарский край
        - Ростовская область
        - Владивосток
2. **Репликация:**
    
    - Каждая шардированная база данных имеет как минимум одну реплику, расположенную в другом дата-центре для отказоустойчивости.
    - Реплики используются для чтений, снижая нагрузку на основной сервер базы данных.
3. **Балансировка нагрузки:**
    
    - Использование балансировщика нагрузки (например, Nginx или HAProxy) для маршрутизации запросов к соответствующему шардированному серверу на основе региона пользователя.
    - Чтения маршрутизируются на реплики, а записи — на основной сервер соответствующего шарда.
4. **Центральный каталог (meta-database):**
    
    - Используется для управления информацией о шардах и репликах. Каталог определяет, какой шард обрабатывает данные конкретного региона.

---

### **Последствия:**

#### **Преимущества:**

1. **Высокая производительность:**
    - Уменьшается время отклика для пользователей за счет обработки запросов в соответствующем регионе.
2. **Отказоустойчивость:**
    - Реплики обеспечивают резервирование данных и быстрое восстановление в случае сбоя основного сервера.
3. **Гибкость масштабирования:**
    - Возможность горизонтального масштабирования путем добавления новых шардов для новых регионов.

#### **Недостатки:**

1. **Сложность архитектуры:**
    - Необходимость настройки, мониторинга и управления как шардированием, так и репликацией.
2. **Проблемы согласованности данных:**
    - Возможны задержки в синхронизации между основными серверами и репликами.
3. **Повышенные затраты:**
    - Дополнительные ресурсы для реплик и шардов увеличивают затраты на инфраструктуру.